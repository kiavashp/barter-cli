// native
var EventEmitter = require('events');

// external
var yargs = require('yargs');
var request = require('request');

var user = {};
var barterClient = new EventEmitter();
var args = yargs.usage('Usage: $0 -u [username] -p [password] [host]')
    .option('u', {
        alias: 'username',
        describe: 'username',
        type: 'string'
    })
    .option('p', {
        alias: 'password',
        describe: 'password',
        type: 'string'
    })
    .option('h', {
        alias: 'host',
        describe: 'password',
        type: 'string'
    })
    .argv;

if (!args.h) {
    args.h = args.host = args._[0] || 'localhost:8000';
}

function whoami(callback) {

    request({
        method: 'GET',
        uri: '/session',
        headers: {
            token: user.token
        },
        json: true
    }, function (err, res, body) {

        if (err || (res.statusCode+'')[0] != 2) {
            callback(err || body);
            return;
        }

        user.id = body.id;

        request({
            method: 'GET',
            uri: '/user/' + user.id,
            headers: {
                token: user.token
            },
            json: true
        }, function (err, res, body) {

            if (err || (res.statusCode+'')[0] != 2) {
                callback(err || body);
                return;
            }

            user.items = body.items;
            user.id = body.id;
            user.username = body.username;

            callback(null, user);

        });

    });

}

function login(username, password, callback) {

    request({
        method: 'POST',
        uri: '/session',
        body: {
            username: username,
            password: password
        },
        json: true
    }, function (err, res, body) {

        if (err || (res.statusCode+'')[0] != 2) {
            callback(err || body);
            return;
        }

        if (body.token) {
            user.token = body.token;
        } else {
            console.log(body.statusCode + ' - ' + body.message);
        }

        whoami(function (err) {
            if (err) {
                callback(err);
                return;
            }
            callback(null, user);
        });

    });

}

function logout(callback) {

    request({
        method: 'DELETE',
        uri: '/session',
        headers: {
            token: user.token
        },
        json: true
    }, function (err, res, body) {

        if (err || (res.statusCode+'')[0] != 2) {
            callback(err || body);
            return;
        }

        user = {};

        callback(null);

    });
}

barterClient.getUser = function () {
    return user;
};
barterClient.whoami = whoami;
barterClient.login = login;
barterClient.logout = logout;

request = request.defaults({
    baseUrl: 'http://' + args.host
});

if (args.username && args.password) {

    barterClient.login(args.username, args.password, function (err) {
        if (err) {
            barterClient.emit('error', err);
            return;
        }
        barterClient.emit('login', user);
    });

}

module.exports = barterClient;
